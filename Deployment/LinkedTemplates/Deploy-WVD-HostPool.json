{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "az_cloudResourcePrefix": {
            "type": "string"
        },
        "az_logAnalyticsWorkspaceId": {
            "type": "string"
        },
        "az_logAnalyticsWorkspaceKey": {
            "type": "string"
        },
        "az_wkstaPrefix": {
            "type": "string"
        },
        "az_vmAdminAccount": {
            "type": "string"
        },
        "az_vmAdminAccountPassword": {
            "type": "securestring"
        },
        "az_deploymentString": {
            "type": "string"
        },
        "az_vmSize": {
            "type": "string"
        },
        "az_vmDiskType": {
            "type": "string"
        },
        "dj_AdminAccountUPN": {
            "type": "string"
        },
        "dj_AdminAccountPassword": {
            "type": "securestring"
        },
        "dj_OrganizationalUnit": {
            "type": "string"
        },
        "dj_Domain": {
            "type": "string"
        },
        "vn_virtualNetworkName": {
            "type": "string"
        },
        "vn_virtualNetworkSubnetPrefix": {
            "type": "string"
        },
        "vn_virtualNetworkResourceGroupName": {
            "type": "string"
        },
        "wvd_buildVersion": {
            "type": "string"
        },
        "wvd_sessionHostTemplateUri": {
            "type": "string"
        },
        "wvd_hostPoolIncrement": {
            "type": "int"
        },
        "wvd_hostPoolType": {
            "type": "string"
        },
        "wvd_maxSessionLimit": {
            "type": "int"
        },
        "wvd_loadBalancerType": {
            "type": "string"
        },
        "wvd_customRdpProperty": {
            "type": "string"
        },
        "wvd_apiVersion": {
            "type": "string"
        },
        "wvd_Env": {
            "type": "string"
        },
        "wvd_Type": {
            "type": "string"
        },
        "wvd_Build": {
            "type": "string"
        },
        "wvd_Role": {
            "type": "string"
        },
        "wvd_deploymentGuid": {
            "type": "string"
        },
        "az_vmImagePublisher": {
            "type": "string"
        },
        "az_vmImageOffer": {
            "type": "string"
        },
        "az_vmImageSKU": {
            "type": "string"
        },
        "az_vmAvailabilityType": {
            "type": "string"
        },
        "wvd_fsLogixVhdLocation": {
            "type": "string"
        },
        "wvd_dscConfiguration": {
            "type": "string"
        },
        "wvd_artifactLocation": {
            "type": "string"
        },
        "az_vmNumberOfInstances": {
            "type": "int"
        },
        "wvd_Canary": {
            "type": "bool"
        }
    },
    "functions": [
        {
            "namespace": "wvdHostPool",
            "members": {
                "getName": {
                    "parameters": [
                        {
                            "name": "RegionPrefix",
                            "type": "string"
                        },
                        {
                            "name": "HostPoolIncrement",
                            "type": "int"
                        }
                    ],
                    "output": {
                        "type": "string",
                        "value": "[toLower(concat(parameters('RegionPrefix'),'-wvd-hostpool-',padLeft(parameters('HostPoolIncrement'),2,'0')))]"
                    }
                }
            }
        },
        {
            "namespace": "wvdSessionHost",
            "members": {
                "getName": {
                    "parameters": [
                        {
                            "name": "SessionHostGroupPrefix",
                            "type": "string"
                        },
                        {
                            "name": "HostPoolIncrement",
                            "type": "int"
                        }
                    ],
                    "output": {
                        "type": "string",
                        "value": "[toLower(concat(parameters('SessionHostGroupPrefix'),'-wshp',padLeft(parameters('HostPoolIncrement'),2,'0')))]"
                    }
                }
            }
        }
    ],
    "variables": {
        "createVMs": "[greater(parameters('az_vmNumberOfInstances'),0)]",
        "wvdHostPoolName": "[wvdHostPool.getName(parameters('az_cloudResourcePrefix'),parameters('wvd_hostPoolIncrement'))]",
        "wvdAssignmentType": "[if(equals(parameters('wvd_hostPoolType'), 'Personal'),'Automatic','')]",
        "wvdshPrefix": "[wvdSessionHost.getName(parameters('az_wkstaPrefix'),parameters('wvd_hostPoolIncrement'))]",
        "wvdSubnetName": "[concat(parameters('vn_virtualNetworkSubnetPrefix'),padLeft(parameters('wvd_hostPoolIncrement'),2,'0'))]",
        "wvdSubnetId": "[resourceId(parameters('vn_virtualNetworkResourceGroupName'),'Microsoft.Network/virtualNetworks/subnets',parameters('vn_virtualNetworkName'), variables('wvdSubnetName'))]",
        "wvdVMTemplate": "[concat(
            '{\"domain\":\"',
            parameters('dj_Domain'),
            '\",\"galleryImageOffer\":\"',
            parameters('az_vmImageOffer'),
            '\",\"galleryImagePublisher\":\"',
            parameters('az_vmImagePublisher'),
            '\",\"galleryImageSKU\":\"',
            parameters('az_vmImageSKU'),
            '\",\"imageType\":\"Gallery\"',
            ',\"imageUri\":null',
            ',\"customImageId\":null',
            ',\"namePrefix\":\"',
            variables('wvdshPrefix'),
            '\",\"osDiskType\":\"',
            parameters('az_vmDiskType'),
            '\",\"useManagedDisks\":true',
            ',\"vmSize\":{\"id\":\"',
            parameters('az_vmSize'),
            '\",\"cores\":2,\"ram\":8}}')]",
        "wvdResourceLocation": "[resourceGroup().location]",
        "wvdResourceGroupName": "[resourceGroup().name]"
    },
    "resources": [
        // Host Pool resource creation
        {
            "type": "Microsoft.DesktopVirtualization/hostpools",
            "apiVersion": "[parameters('wvd_apiVersion')]",
            "name": "[variables('wvdHostPoolName')]",
            "location": "[variables('wvdResourceLocation')]",
            "tags": {
                "WVD-Maintenance": "True",
                "WVD-Environment": "[parameters('wvd_Env')]",
                "WVD-Type": "[parameters('wvd_Type')]",
                "WVD-Build": "[parameters('wvd_Build')]",
                "WVD-Role": "[parameters('wvd_Role')]",
                "WVD-DeploymentGuid": "[parameters('wvd_deploymentGuid')]",
                "WVD-BuildVersion": "[parameters('wvd_buildVersion')]",
                "WVD-DscConfiguration": "[parameters('wvd_dscConfiguration')]",
                "WVD-FsLogixVhdLocation": "[parameters('wvd_fsLogixVhdLocation')]",
                "WVD-ArtifactLocation": "[parameters('wvd_artifactLocation')]"
            },
            "properties": {
                "friendlyName": "[if(parameters('wvd_Canary'),concat(parameters('wvd_Env'),'-',parameters('wvd_Type'),'-',parameters('wvd_Build'),'-',parameters('wvd_Role')),concat('(Canary) ',parameters('wvd_Env'),'-',parameters('wvd_Type'),'-',parameters('wvd_Build'),'-',parameters('wvd_Role')))]",
                "hostpoolType": "[parameters('wvd_hostPoolType')]",
                "customRdpProperty": "[parameters('wvd_customRdpProperty')]",
                "maxSessionLimit": "[parameters('wvd_maxSessionLimit')]",
                "loadBalancerType": "[parameters('wvd_loadBalancerType')]",
                "personalDesktopAssignmentType": "[variables('wvdAssignmentType')]",
                "ring": null,
                "registrationInfo": {},
                "vmTemplate": "[variables('wvdVMTemplate')]"
            }
        },
        // Desktop Application Group resource creation
        {
            "type": "Microsoft.DesktopVirtualization/applicationgroups",
            "apiVersion": "[parameters('wvd_apiVersion')]",
            "name": "[concat(variables('wvdHostPoolName'),'-DAG')]",
            "location": "[variables('wvdResourceLocation')]",
            "tags": {
                "WVD-Environment": "[parameters('wvd_Env')]",
                "WVD-Type": "[parameters('wvd_Type')]",
                "WVD-Build": "[parameters('wvd_Build')]",
                "WVD-Role": "[parameters('wvd_Role')]",
                "WVD-BuildVersion": "[parameters('wvd_buildVersion')]"
            },
            "properties": {
                "hostpoolarmpath": "[resourceId('Microsoft.DesktopVirtualization/hostpools/', variables('wvdHostPoolName'))]",
                "friendlyName": "[concat(parameters('wvd_Build'),'-',parameters('wvd_Role'),'-',parameters('wvd_Type'),'-Desktop')]",
                "description": "[concat(parameters('wvd_Build'),'-',parameters('wvd_Role'),'-',parameters('wvd_Type'),'-Desktop')]",
                "applicationGroupType": "Desktop"
            },
            "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostpools/', variables('wvdHostPoolName'))]"
            ]
        },
        // Session Host resource deployment; copy iteration based on 'wvd_groupReference' parameter
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('Deploy-WVD-SessionHosts-',parameters('az_deploymentString'))]",
            "condition": "[variables('createVMs')]",
            "resourceGroup": "[variables('wvdResourceGroupName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[parameters('wvd_sessionHostTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "az_logAnalyticsWorkspaceId": {
                        "value": "[parameters('az_logAnalyticsWorkspaceId')]"
                    },
                    "az_logAnalyticsWorkspaceKey": {
                        "value": "[parameters('az_logAnalyticsWorkspaceKey')]"
                    },
                    "az_vmSize": {
                        "value": "[parameters('az_vmSize')]"
                    },
                    "az_vmNumberOfInstances": {
                        "value": "[parameters('az_vmNumberOfInstances')]"
                    },
                    "az_vmNamePrefix": {
                        "value": "[variables('wvdshPrefix')]"
                    },
                    "az_vmImageOffer": {
                        "value": "[parameters('az_vmImageOffer')]"
                    },
                    "az_vmImagePublisher": {
                        "value": "[parameters('az_vmImagePublisher')]"
                    },
                    "az_vmImageSKU": {
                        "value": "[parameters('az_vmImageSKU')]"
                    },
                    "az_vmDiskType": {
                        "value": "[parameters('az_vmDiskType')]"
                    },
                    "dj_AdminAccountUPN": {
                        "value": "[parameters('dj_AdminAccountUPN')]"
                    },
                    "dj_AdminAccountPassword": {
                        "value": "[parameters('dj_AdminAccountPassword')]"
                    },
                    "dj_OrganizationalUnit": {
                        "value": "[parameters('dj_OrganizationalUnit')]"
                    },
                    "dj_Domain": {
                        "value": "[parameters('dj_Domain')]"
                    },                  
                    "wvd_buildVersion": {
                        "value": "[parameters('wvd_buildVersion')]"
                    },
                    "wvd_Env": {
                        "value": "[parameters('wvd_Env')]"
                    },
                    "wvd_Type": {
                        "value": "[parameters('wvd_Type')]"
                    },
                    "wvd_Build": {
                        "value": "[parameters('wvd_Build')]"
                    },
                    "wvd_Role": {
                        "value": "[parameters('wvd_Role')]"
                    },
                    "wvd_hostPoolName": {
                        "value": "[variables('wvdHostPoolName')]"
                    },
                    "wvd_subnetId": {
                        "value": "[variables('wvdSubnetId')]"
                    },
                    "az_vmAdminAccount": {
                        "value": "[parameters('az_vmAdminAccount')]"
                    },
                    "az_vmAdminAccountPassword": {
                        "value": "[parameters('az_vmAdminAccountPassword')]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "hostPoolName": {
            "type": "string",
            "value": "[variables('wvdHostPoolName')]"
        },
        "resourceGroupName": {
            "type": "string",
            "value": "[variables('wvdResourceGroupName')]"
        },
        "sessionHostNames": {
            "type": "array",
            "value": "[reference(concat('Deploy-WVD-SessionHosts-',parameters('az_deploymentString'))).outputs.sessionHostNames.value]"
        }
    }
}