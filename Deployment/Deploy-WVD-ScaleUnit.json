{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "az_vmSize": {
            "type": "string"
        },
        "az_vmDiskType": {
            "type": "string"
        },
        "az_cloudResourcePrefix": {
            "type": "string"
        },
        "az_wkstaPrefix": {
            "type": "string"
        },
        "vn_virtualNetworkName": {
            "type": "string"
        },
        "vn_virtualNetworkSubnetPrefix": {
            "type": "string"
        },
        "vn_virtualNetworkResourceGroupName": {
            "type": "string"
        },
        "wvd_buildVersion": {
            "type": "string"
        },
        "wvd_deploymentString": {
            "type": "string",
        },
        "wvd_hostPoolInitialValue": {
            "type": "int"
        },
        "wvd_hostPoolTemplateUri": {
            "type": "string",
        },
        "wvd_sessionHostTemplateUri": {
            "type": "string"
        },
        "wvd_keyVaultId": {
            "type": "string"
        },
        "wvd_workspaceResourceGroup": {
            "type": "string"
        },
        "wvd_hostPoolResourceGroupPrefix": {
            "type": "string"
        },
        "wvd_maxSessionLimit": {
            "type": "int"
        },
        "wvd_loadBalancerType": {
            "type": "string"
        },
        "wvd_customRdpProperty": {
            "type": "string"
        },
        "wvd_apiVersion": {
            "type": "string"
        },
        "wvd_workspaceName": {
            "type": "string"
        },
        "wvd_hostPoolConfig": {
            "type": "object"
        },
        "domain": {
            "type": "string"
        }
    },
    "variables": {
        "copy": [{
            "name": "wvdAppGroupArray",
            "count": "[length(parameters('wvd_hostPoolConfig').configs)]",
            "input": "[resourceId(concat(parameters('wvd_hostPoolResourceGroupPrefix'),padleft(add(parameters('wvd_hostPoolInitialValue'),copyIndex('wvdAppGroupArray')),2,'0')),'Microsoft.DesktopVirtualization/applicationgroups/',concat(parameters('az_cloudResourcePrefix'),'-wvd-hostpool-',padLeft(add(parameters('wvd_hostPoolInitialValue'),copyIndex('wvdAppGroupArray')),2,'0'),'-DAG'))]"
        }],
        "wvdResourceLocation": "[resourceGroup().location]",
        "azDeploymentString": "[parameters('wvd_deploymentString')]"
    },
    "resources": [
        // Host Pool resource deployment; copy iteration based on array length of 'wvd_hostPoolconfig' parameter
        {
            "apiVersion": "2018-05-01",
            "name": "[concat('Deploy-WVD-HostPool-',padLeft(add(parameters('wvd_hostPoolInitialValue'),copyIndex()),2,'0'),'-',variables('azDeploymentString'))]",
            "type": "Microsoft.Resources/deployments",
            "resourceGroup": "[concat(parameters('wvd_hostPoolResourceGroupPrefix'),padleft(add(parameters('wvd_hostPoolInitialValue'),copyIndex()),2,'0'))]",
            "copy": {
                "name": "WVD-HostPool-Loop",
                "count": "[length(parameters('wvd_hostPoolConfig').configs)]"
            },
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[parameters('wvd_hostPoolTemplateUri')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "az_logAnalyticsWorkspaceId": {
                        "reference": {
                            "keyVault": {
                            "id": "[parameters('wvd_keyVaultId')]"
                            },
                            "secretName": "WVD-LA-WorkspaceId"
                        }
                    },
                    "az_logAnalyticsWorkspaceKey": {
                        "reference": {
                            "keyVault": {
                            "id": "[parameters('wvd_keyVaultId')]"
                            },
                            "secretName": "WVD-LA-WorkspaceKey"
                        }
                    },
                    "az_vmAdminAccount": {
                        "reference": {
                            "keyVault": {
                            "id": "[parameters('wvd_keyVaultId')]"
                            },
                            "secretName": "WVD-VM-LocalAdmin-Account"
                        }
                    },
                    "az_vmAdminAccountPassword": {
                        "reference": {
                            "keyVault": {
                            "id": "[parameters('wvd_keyVaultId')]"
                            },
                            "secretName": "WVD-VM-LocalAdmin-Password"
                        }
                    },
                    "dj_AdminAccountUPN": {
                        "reference": {
                            "keyVault": {
                            "id": "[parameters('wvd_keyVaultId')]"
                            },
                            "secretName": "WVD-VM-DomainJoin-Account"
                        }
                    },
                    "dj_AdminAccountPassword": {
                        "reference": {
                            "keyVault": {
                            "id": "[parameters('wvd_keyVaultId')]"
                            },
                            "secretName": "WVD-VM-DomainJoin-Password"
                        }
                    },
                    "dj_OrganizationalUnit": {
                        "reference": {
                            "keyVault": {
                            "id": "[parameters('wvd_keyVaultId')]"
                            },
                            "secretName": "WVD-SessionHost-OU"
                        }
                    },
                    "dj_Domain": {
                        "value": "[parameters('domain')]"
                    },
                    "az_cloudResourcePrefix": {
                        "value": "[parameters('az_cloudResourcePrefix')]"
                    },
                    "az_wkstaPrefix": {
                        "value": "[parameters('az_wkstaPrefix')]"
                    },
                    "az_deploymentString": {
                        "value": "[variables('azDeploymentString')]"
                    },
                    "az_vmSize": {
                        "value": "[parameters('az_vmSize')]"
                    },
                    "az_vmDiskType": {
                        "value": "[parameters('az_vmDiskType')]"
                    },
                    "vn_virtualNetworkName": {
                        "value": "[parameters('vn_virtualNetworkName')]"
                    },
                    "vn_virtualNetworkSubnetPrefix": {
                        "value": "[parameters('vn_virtualNetworkSubnetPrefix')]"
                    },
                    "vn_virtualNetworkResourceGroupName": {
                        "value": "[parameters('vn_virtualNetworkResourceGroupName')]"
                    },
                    "wvd_buildVersion": {
                        "value": "[parameters('wvd_buildVersion')]"
                    },
                    "wvd_sessionHostTemplateUri": {
                        "value": "[parameters('wvd_sessionHostTemplateUri')]"
                    },
                    "wvd_hostPoolIncrement": {
                        "value": "[add(parameters('wvd_hostPoolInitialValue'),copyIndex())]"
                    },
                    "wvd_maxSessionLimit": {
                        "value": "[parameters('wvd_maxSessionLimit')]"
                    },
                    "wvd_loadBalancerType": {
                        "value": "[parameters('wvd_loadBalancerType')]"
                    },
                    "wvd_customRdpProperty": {
                        "value": "[parameters('wvd_customRdpProperty')]"
                    },
                    "wvd_apiVersion": {
                        "value": "[parameters('wvd_apiVersion')]"
                    },
                    "wvd_Env": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdEnv]"
                    },
                    "wvd_Type": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdType]"
                    },
                    "wvd_Build": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdBuild]"
                    },
                    "wvd_Role": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdRole]"
                    },
                    "az_vmImagePublisher": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].azVmImagePublisher]"
                    },
                    "az_vmImageOffer": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].azVmImageOffer]"
                    },
                    "az_vmImageSKU": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].azVmImageSku]"
                    },
                    "az_vmAvailabilityType": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].azVmAvailabilityType]"
                    },
                    "wvd_fsLogixVhdLocation": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].fsLogixVhdLocation]"
                    },
                    "wvd_dscConfiguration": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].dscConfiguration]"
                    },
                    "wvd_artifactLocation": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdArtifactLocation]"
                    },
                    "az_vmNumberOfInstances": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].azVmNumberOfInstances]"
                    },
                    "wvd_Canary": {
                        "value": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdCanary]"
                    }
                }
            },
            "dependsOn": [
            ]
        },
        // Workspace resource; configures the workspace to include the newly created application groups
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "Deploy-WVD-Workspace",
            "resourceGroup": "[parameters('wvd_workspaceResourceGroup')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": [{
                        "type": "Microsoft.DesktopVirtualization/workspaces",
                        "apiVersion": "[parameters('wvd_apiVersion')]",
                        "name": "[parameters('wvd_workspaceName')]",                        
                        "location": "[variables('wvdResourceLocation')]",
                        "properties": {
                            "applicationGroupReferences": "[concat(reference(resourceId(parameters('wvd_workspaceResourceGroup'),'Microsoft.DesktopVirtualization/workspaces',parameters('wvd_workspaceName')),'2019-12-10-preview','Full').properties.applicationGroupReferences,variables('wvdAppGroupArray'))]"
                        }
                    }]
                }
            },
            "dependsOn": [
               "WVD-HostPool-Loop"
            ]
        }
    ],
    "outputs": {
        "hostPoolsDeployed": {
            "type": "array",
            "copy": {
                "count": "[length(parameters('wvd_hostPoolConfig').configs)]",
                "input": {
                    "imagePublisher": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].azVmImagePublisher]",
                    "hostpoolName": "[reference(concat('Deploy-WVD-HostPool-',padLeft(add(parameters('wvd_hostPoolInitialValue'),copyIndex()),2,'0'),'-',variables('azDeploymentString'))).outputs.hostPoolName.value]",
                    "resourceGroupName": "[reference(concat('Deploy-WVD-HostPool-',padLeft(add(parameters('wvd_hostPoolInitialValue'),copyIndex()),2,'0'),'-',variables('azDeploymentString'))).outputs.resourceGroupName.value]",
                    "wvdEnv": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdEnv]",
                    "wvdType": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdType]",
                    "wvdBuild": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdBuild]",
                    "wvdRole": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdRole]",
                    "dscConfiguration": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].dscConfiguration]",
                    "fsLogixVhdLocation": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].fsLogixVhdLocation]",
                    "wvdArtifactLocation": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdArtifactLocation]",
                    "sessionHostNames": "[reference(concat('Deploy-WVD-HostPool-',padLeft(add(parameters('wvd_hostPoolInitialValue'),copyIndex()),2,'0'),'-',variables('azDeploymentString'))).outputs.sessionHostNames.value]",
                    "wvdCanary": "[parameters('wvd_hostPoolConfig').configs[copyIndex()].wvdCanary]"
                }
            }
        }
    }
}